<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Pixelová Říše - Lobby</title>
    <link rel="stylesheet" href="styl.css">
</head>
<body>
    <div class="lobby-container" id="name-selection">
        <h1>Pixelová Říše</h1>
        <input type="text" id="playerName" placeholder="Zadej své jméno...">
        <button id="enterLobbyBtn">Vstoupit do lobby</button>
    </div>

    <div class="lobby-container" id="game-selection" style="display: none;">
        <h2>Vítej, <span id="lobbyPlayerName"></span>!</h2>
        <button id="findGameBtn">Najít hru</button>
        <button id="createGameBtn">Vytvořit soukromou hru</button>
        <div class="join-game">
            <input type="text" id="gameCodeInput" placeholder="Zadej kód hry...">
            <button id="joinGameBtn">Připojit se kódem</button>
        </div>
    </div>

    <div class="lobby-container" id="waiting-room" style="display: none;">
        <h3>Čekárna</h3>
        <p>Kód tvé hry: <strong id="gameCodeDisplay"></strong></p>
        <p>Pošli tento kód přátelům nebo počkej, až se někdo připojí.</p>
        <h4>Hráči v lobby:</h4>
        <ul id="playerList"></ul>
        <button id="startGameBtn" disabled>Spustit hru (min. 2 hráči)</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const nameSelection = document.getElementById('name-selection');
        const gameSelection = document.getElementById('game-selection');
        const waitingRoom = document.getElementById('waiting-room');

        const enterLobbyBtn = document.getElementById('enterLobbyBtn');
        const findGameBtn = document.getElementById('findGameBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        
        const playerNameInput = document.getElementById('playerName');
        
        let playerName = '';
        let initialGameState = null; // Místo pro uložení dat

        enterLobbyBtn.addEventListener('click', () => {
            playerName = playerNameInput.value;
            if (!playerName) { alert('Zadej jméno.'); return; }
            socket.emit('playerEnteredLobby', playerName);
            document.getElementById('lobbyPlayerName').textContent = playerName;
            nameSelection.style.display = 'none';
            gameSelection.style.display = 'block';
        });

        findGameBtn.addEventListener('click', () => socket.emit('findGame'));
        createGameBtn.addEventListener('click', () => socket.emit('createGame'));
        joinGameBtn.addEventListener('click', () => {
            const code = document.getElementById('gameCodeInput').value;
            if (code) socket.emit('joinGame', code);
        });
        startGameBtn.addEventListener('click', () => {
            // Zobrazíme "Hra se spouští..." hned, aby hráč věděl, že se něco děje
            document.body.innerHTML = '<h1>Hra se spouští...</h1>';
            socket.emit('startGame');
        });

        socket.on('gameCreated', (gameCode) => {
            gameSelection.style.display = 'none';
            waitingRoom.style.display = 'block';
            document.getElementById('gameCodeDisplay').textContent = gameCode;
        });

        socket.on('joinSuccess', (gameCode) => {
            gameSelection.style.display = 'none';
            waitingRoom.style.display = 'block';
            document.getElementById('gameCodeDisplay').textContent = gameCode;
        });

        socket.on('updatePlayerList', (players) => {
            const playerListEl = document.getElementById('playerList');
            playerListEl.innerHTML = '';
            let meIsHost = false;
            players.forEach((p, index) => {
                const li = document.createElement('li');
                li.textContent = p.name + (index === 0 ? ' (Host)' : '');
                playerListEl.appendChild(li);
                if (p.id === socket.id && index === 0) {
                    meIsHost = true;
                }
            });
            startGameBtn.style.display = meIsHost ? 'block' : 'none';
            startGameBtn.disabled = players.length < 2;
        });
        
        // KROK 1: Uložíme si data, až přijdou.
        socket.on('initialGameState', (state) => {
            initialGameState = state;
            // Pokud jsme už dostali pokyn ke startu, přesměrujeme se
            if (document.body.innerHTML.includes('<h1>Hra se spouští...</h1>')) {
                proceedToGame();
            }
        });
        
        // KROK 2: Až přijde pokyn ke startu, zkontrolujeme, jestli už máme data
        socket.on('gameStarting', () => {
            document.body.innerHTML = '<h1>Hra se spouští...</h1>';
            // Pokud už máme data, přesměrujeme se. Pokud ne, počkáme, až dorazí.
            if (initialGameState) {
                proceedToGame();
            }
        });

        function proceedToGame() {
            sessionStorage.setItem('initialGameState', JSON.stringify(initialGameState));
            window.location.href = `/hra.html?gameCode=${initialGameState.code}`;
        }

        socket.on('error', (message) => alert('Chyba: ' + message));
    </script>
</body>
</html>