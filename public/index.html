<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Pixelov√° ≈ò√≠≈°e</title>
    <link rel="stylesheet" href="styl.css">
</head>
<body>
    <!-- Sekce LOBBY -->
    <div id="lobby-section">
        <div class="lobby-container" id="name-selection">
            <h1>Pixelov√° ≈ò√≠≈°e</h1>
            <input type="text" id="playerName" placeholder="Zadej sv√© jm√©no...">
            <button id="enterLobbyBtn">Vstoupit do lobby</button>
        </div>
        <div class="lobby-container" id="game-selection" style="display: none;">
            <h2>V√≠tej, <span id="lobbyPlayerName"></span>!</h2>
            <button id="findGameBtn">Naj√≠t hru</button>
            <button id="createGameBtn">Vytvo≈ôit soukromou hru</button>
            <div class="join-game">
                <input type="text" id="gameCodeInput" placeholder="Zadej k√≥d hry...">
                <button id="joinGameBtn">P≈ôipojit se k√≥dem</button>
            </div>
        </div>
        <div class="lobby-container" id="waiting-room" style="display: none;">
            <h3>ƒåek√°rna</h3>
            <p>K√≥d tv√© hry: <strong id="gameCodeDisplay"></strong></p>
            <h4>Hr√°ƒçi v lobby:</h4>
            <ul id="playerList"></ul>
            <button id="startGameBtn" disabled>Spustit hru (min. 2 hr√°ƒçi)</button>
        </div>
    </div>

    <!-- Sekce HRA -->
    <div id="game-section" style="display: none;">
        <div class="info-column">
            <div class="stats-panel">
                <h2 id="player-name-display">STAV ≈ò√ç≈†E</h2>
                <div class="stat"><span>üí∞ Zlato:</span> <span id="gold-display" class="stat-value">0</span></div>
                <div class="stat"><span>üíé Krystaly:</span> <span id="crystals-display" class="stat-value">0</span></div>
                <div class="stat"><span>‚öîÔ∏è Jednotky:</span> <span id="units-display" class="stat-value">0</span></div>
                <div class="stat"><span>üõ∞Ô∏è Expedice:</span> <span id="expeditions-display" class="stat-value">0</span></div>
                <div class="stat"><span>üåç √özem√≠:</span> <span id="territory-display" class="stat-value">0</span></div>
                <button class="unit-buy-button" id="buy-unit-button">Koupit jednotku (50üí∞)</button>
                <div class="stat-slider">
                    <label for="expedition-slider">Velikost expedice:</label>
                    <input type="range" id="expedition-slider" min="1" max="100" value="10">
                    <span id="expedition-slider-value">10% (0)</span>
                </div>
            </div>
            <div class="minimap-panel">
                <h3>Minimapa</h3>
                <canvas id="minimap" width="280" height="280"></canvas>
            </div>
        </div>
        <div class="game-column">
            <div id="game-viewport">
                <canvas id="game-canvas"></canvas>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        // --- P≈ôep√≠n√°n√≠ pohled≈Ø ---
        const lobbySection = document.getElementById('lobby-section');
        const gameSection = document.getElementById('game-section');

        function showLobby() { lobbySection.style.display = 'flex'; gameSection.style.display = 'none'; }
        function showGame() { lobbySection.style.display = 'none'; gameSection.style.display = 'flex'; }

        // --- LOBBY LOGIKA ---
        const nameSelection = document.getElementById('name-selection');
        const gameSelection = document.getElementById('game-selection');
        const waitingRoom = document.getElementById('waiting-room');
        const enterLobbyBtn = document.getElementById('enterLobbyBtn');
        const findGameBtn = document.getElementById('findGameBtn');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const playerNameInput = document.getElementById('playerName');

        enterLobbyBtn.addEventListener('click', () => {
            const playerName = playerNameInput.value;
            if (!playerName) { alert('Zadej jm√©no.'); return; }
            socket.emit('playerEnteredLobby', playerName);
            document.getElementById('lobbyPlayerName').textContent = playerName;
            nameSelection.style.display = 'none';
            gameSelection.style.display = 'block';
        });

        findGameBtn.addEventListener('click', () => socket.emit('findGame'));
        createGameBtn.addEventListener('click', () => socket.emit('createGame'));
        joinGameBtn.addEventListener('click', () => {
            const code = document.getElementById('gameCodeInput').value;
            if (code) socket.emit('joinGame', code);
        });
        startGameBtn.addEventListener('click', () => socket.emit('startGame'));

        socket.on('gameCreated', (gameCode) => {
            gameSelection.style.display = 'none';
            waitingRoom.style.display = 'block';
            document.getElementById('gameCodeDisplay').textContent = gameCode;
        });

        socket.on('joinSuccess', (gameCode) => {
            gameSelection.style.display = 'none';
            waitingRoom.style.display = 'block';
            document.getElementById('gameCodeDisplay').textContent = gameCode;
        });

        socket.on('updatePlayerList', (players) => {
            const playerListEl = document.getElementById('playerList');
            playerListEl.innerHTML = '';
            let meIsHost = false;
            players.forEach((p, index) => {
                const li = document.createElement('li');
                li.textContent = p.name + (index === 0 ? ' (Host)' : '');
                playerListEl.appendChild(li);
                if (p.id === socket.id && index === 0) meIsHost = true;
            });
            startGameBtn.style.display = meIsHost ? 'block' : 'none';
            startGameBtn.disabled = players.length < 2;
        });

        socket.on('error', (message) => alert('Chyba: ' + message));

        // --- HERN√ç LOGIKA ---
        let gameState = null;
        let myId = null;
        const CELL_SIZE = 10;
        const viewportEl = document.getElementById('game-viewport');
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const minimapCanvas = document.getElementById('minimap');
        const minimapCtx = minimapCanvas.getContext('2d');
        const ICON_MAP = { base: 'üè°', village: 'üèòÔ∏è', mine: '‚õèÔ∏è', crystal_mine: 'üíé', ancient_library: 'üìö', trading_post: '‚öñÔ∏è', barracks: '‚öîÔ∏è', watchtower: 'üëÅÔ∏è' };

        function initializeGame(initialState) {
            gameState = initialState;
            myId = socket.id;
            gameState.structures = new Map(initialState.structures.map(s => [s.id, s]));
            showGame();
            resizeCanvas();
            gameLoop();
        }

        socket.on('gameStarted', initializeGame);
        socket.on('gameStateUpdate', (updatePacket) => {
            if (!gameState) return;
            updatePacket.players.forEach(updatedPlayer => {
                const playerIndex = gameState.players.findIndex(p => p.id === updatedPlayer.id);
                if (playerIndex !== -1) {
                    Object.assign(gameState.players[playerIndex], updatedPlayer);
                }
            });

            gameState.expeditions = updatePacket.expeditions;
            
            updatePacket.boardChanges.forEach(change => {
                if (gameState.gameBoard[change.y]?.[change.x]) {
                    gameState.gameBoard[change.y][change.x].ownerId = change.ownerId;
                }
            });
        });
        
        let camera = { x: 0, y: 0, scale: 0.5 };
        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if (!gameState) return;
            ctx.save();
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.translate(camera.x, camera.y);
            ctx.scale(camera.scale, camera.scale);
            
            renderBoard();
            renderStructures();
            renderExpeditions();
            
            ctx.restore();
            renderMinimap();
            renderUI();
        }
        
        function renderBoard() {
            const view = { left: -camera.x / camera.scale, top: -camera.y / camera.scale, right: (canvas.width - camera.x) / camera.scale, bottom: (canvas.height - camera.y) / camera.scale };
            const startX = Math.max(0, Math.floor(view.left / CELL_SIZE));
            const endX = Math.min(gameState.gridSize, Math.ceil(view.right / CELL_SIZE));
            const startY = Math.max(0, Math.floor(view.top / CELL_SIZE));
            const endY = Math.min(gameState.gridSize, Math.ceil(view.bottom / CELL_SIZE));
            const colorMap = new Map(gameState.players.map(p => [p.id, p.color]));
            colorMap.set(null, '#282828');

            for (let y = startY; y < endY; y++) {
                for (let x = startX; x < endX; x++) {
                    const cell = gameState.gameBoard[y][x];
                    ctx.fillStyle = colorMap.get(cell.ownerId);
                    ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }

        function renderStructures() {
            const playerColorMap = new Map(gameState.players.map(p => [p.id, p.color]));
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            gameState.structures.forEach(s => {
                const sCenterX = s.x * CELL_SIZE + (s.w * CELL_SIZE / 2);
                const sCenterY = s.y * CELL_SIZE + (s.h * CELL_SIZE / 2);
                
                if (s.ownerId) {
                    ctx.strokeStyle = playerColorMap.get(s.ownerId) || '#888';
                    ctx.lineWidth = 2 / camera.scale;
                    ctx.strokeRect(s.x * CELL_SIZE, s.y * CELL_SIZE, s.w * CELL_SIZE, s.h * CELL_SIZE);
                }

                const icon = ICON_MAP[s.type.replace('owned_', '')];
                if(icon) {
                    ctx.font = `${s.w * CELL_SIZE * 0.8}px sans-serif`;
                    ctx.fillStyle = 'white';
                    ctx.fillText(icon, sCenterX, sCenterY);
                }
            });
        }

        function renderExpeditions() {
            const playerColorMap = new Map(gameState.players.map(p => [p.id, p.color]));
            gameState.expeditions.forEach(exp => {
                const color = playerColorMap.get(exp.ownerId) || 'grey';
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(exp.currentX * CELL_SIZE, exp.currentY * CELL_SIZE, CELL_SIZE * 0.75, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function renderMinimap() {
             const size = gameState.gridSize;
             const pixelSize = minimapCanvas.width / size;
             minimapCtx.fillStyle = '#000';
             minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
             const colorMap = new Map(gameState.players.map(p => [p.id, p.color]));

             for(let y=0; y < size; y++){
                for(let x=0; x < size; x++){
                    const ownerId = gameState.gameBoard[y][x].ownerId;
                    if(ownerId){
                         minimapCtx.fillStyle = colorMap.get(ownerId);
                         minimapCtx.fillRect(x * pixelSize, y * pixelSize, 1, 1);
                    }
                }
            }
        }

        function renderUI() {
            const me = gameState.players.find(p => p.id === myId);
            if(me) {
                document.getElementById('player-name-display').textContent = me.name;
                document.getElementById('player-name-display').style.color = me.color;
                document.getElementById('gold-display').textContent = Math.floor(me.gold);
                document.getElementById('crystals-display').textContent = Math.floor(me.crystals);
                document.getElementById('units-display').textContent = me.units;
                document.getElementById('territory-display').textContent = me.territoryCount;
                document.getElementById('expeditions-display').textContent = gameState.expeditions.filter(e => e.ownerId === myId).length;
                updateSliderLabel(me.units);
            }
        }

        function updateSliderLabel(totalUnits) {
            const percentage = document.getElementById('expedition-slider').value;
            const unitsToSend = Math.max(1, Math.ceil(totalUnits * (percentage / 100)));
            document.getElementById('expedition-slider-value').textContent = `${percentage}% (${unitsToSend} ‚öîÔ∏è)`;
        }
        
        function resizeCanvas() { canvas.width = viewportEl.clientWidth; canvas.height = viewportEl.clientHeight; }
        window.addEventListener('resize', resizeCanvas);
        
        let isDragging = false, didDrag = false, startPos = { x: 0, y: 0 };
        canvas.addEventListener('mousedown', (e) => { if (e.button !== 0) return; isDragging = true; didDrag = false; startPos.x = e.clientX - camera.x; startPos.y = e.clientY - camera.y; });
        canvas.addEventListener('mousemove', (e) => { if (!isDragging) return; didDrag = true; camera.x = e.clientX - startPos.x; camera.y = e.clientY - startPos.y; });
        canvas.addEventListener('mouseup', () => { isDragging = false; });
        canvas.addEventListener('wheel', (e) => { 
            e.preventDefault(); 
            const mouseX = e.clientX - canvas.getBoundingClientRect().left;
            const mouseY = e.clientY - canvas.getBoundingClientRect().top;
            const zoom = Math.pow(1.1, -e.deltaY * 0.01);
            const newScale = Math.max(0.1, Math.min(camera.scale * zoom, 5.0));
            camera.x = mouseX - (mouseX - camera.x) * (newScale / camera.scale);
            camera.y = mouseY - (mouseY - camera.y) * (newScale / camera.scale);
            camera.scale = newScale;
        }, { passive: false });

        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (didDrag) return;
            const me = gameState.players.find(p => p.id === myId);
            if(!me) return;
            
            const worldX = (e.clientX - canvas.getBoundingClientRect().left - camera.x) / camera.scale;
            const worldY = (e.clientY - canvas.getBoundingClientRect().top - camera.y) / camera.scale;
            const targetX = Math.floor(worldX / CELL_SIZE);
            const targetY = Math.floor(worldY / CELL_SIZE);
            const unitsToSend = Math.max(1, Math.ceil(me.units * (document.getElementById('expedition-slider').value / 100)));

            socket.emit('launchExpedition', { gameCode: gameState.code, target: { x: targetX, y: targetY }, units: unitsToSend });
        });
        document.getElementById('buy-unit-button').addEventListener('click', () => {
             socket.emit('buyUnit', { gameCode: gameState.code });
        });
    </script>
</body>
</html>